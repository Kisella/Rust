# 声明式宏
## 0 实践
```rust
#[macro_export]
macro_rules! hashmap {
    ($($key:expr => $value:expr),*$(,)?) => {
        {
            let mut map = std::collections::HashMap::new();
            $(map.insert($key, $value);)*
            map
        }
    }
}
```


## 1 语法
```rust
#[macro_export]
macro_rules! macro_name {
    (pattern1) => { expansion1 };
    (pattern2) => { expansion2 };
    // ... 更多规则
}
```
- __`#[marco_export]`__ 表示这个宏在当前crate被引入作用域时也能被访问到
- __`macro_rules!`__ 声明宏的关键字，后边跟着宏的名字
- 大括号`{}`包裹的是宏的规则，规则可以有一条或多条
- 一条规则由模式匹配`(pattern)`,右箭头`=>`, 展开部分`{ expansion }`，分号`;`构成

## 2 $符号
### 2.1 引入元变量
模式匹配`pattern`中，`$`后面跟着一个标识符（元变量的名字）和一个冒号`:`，再加上一个元变量类型符（如expr、ident等），用于匹配特定类型的代码片段。
```rust
$x:expr      // 声明一个名称为x，类型为expr（表达式）的元变量
```

### 2.2 替换元变量
在宏的展开部分`{expansion}`，`$x`会被替换为匹配到的代码片段

### 2.3 重复模式
在宏中，重复模式使用`$(...)*`、`$(...)+`或`$(...)?`来表示。`*+?`类似与正则表达式中的重复符，其中：
- `*` 表示0次或多次。
- `+` 表示1次或多次。
- `?` 表示0次或1次。

在重复模式中，`$`用于指定要重复的元变量，并且可以在展开部分使用相同的语法进行重复展开。

#### 2.3.1 引用元变量时使用重复模式
引用元变量时使用重复模式, 使用美元符号`$`和重复符将引入元变量的语句（例如$x:expr）包裹起来;重复符前可以使用逗号、分号等声明为分隔符号，当不声明分隔符号时，默认分割符号为空格。
```rust
($($x:expr),*)    // 使用逗号作为分隔符号
($($x:expr)*)     // 使用空格作为分隔符号
```


#### 2.3.2 展开部分使用重复模式
展开部分使用重复模式，使用`$(...)*`来包裹需要重复的展开的代码片段。

## 3 元变量类型
元变量类型（fragment specifiers）用于指定宏模式中匹配的代码片段类型
|   元变量   |   描述   |          匹配示例          |                 说明                 |
| :--------: | :------: | :------------------------: | :----------------------------------: |
|  `ident`   |  标识符  |     `x, foo, MyStruct`     | 变量、函数、结构体、模块等实体的名称 |
|   `expr`   |  表达式  | `2 + 2, foo(),`<br>`if x { y }` |会产生值的代码片段|
|    `ty`    |   类型   |   `i32, String, Vec<T>`    |固有类型或自定义类型|
|   `pat`    |   模式   |    `Some(x), _, 1..=5`     |                                      用于匹配值的结构|
|   `stmt`   |   语句   |        `let x = 1;`        |语句以分号`;`结尾|
|  `block`   |  代码块  |         `{ x; y }`         |由大括号`{}`包裹一条或多条语句|
|   `item`   |   条目   |   `fn f() {}, struct S;`   |可以在命名空间中声明的实体，通常是模块级别的定义|
|   `meta`   |  元数据  |     `#[derive(Debug)]`     |-|
|    `tt`    |  标记树  |        任意单个标记        |                                      |
| `lifetime` | 生命周期 |       `'a, 'static`        |-|
|   `vis`    |  可见性  |     `pub, pub(crate)`      |-|
| `literal`  |  字面量  |    `"hello", 42, 3.14`     |-|

